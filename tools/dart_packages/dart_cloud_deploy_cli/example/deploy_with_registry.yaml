# =============================================================================
# DART CLOUD DEPLOY CONFIGURATION
# =============================================================================
# This configuration file supports local deployment with flexible options:
#
# ENVIRONMENT RESOLUTION PRIORITY:
#   1. CLI --env-file argument (highest priority)
#   2. env_file_path in this config
#   3. OpenBao secrets (fallback)
#   4. Exception if none available
#
# CONTAINER CONFIGURATION PRIORITY:
#   1. Environment-specific (local_container, staging_container, production_container)
#   2. Base container (fallback)
#   3. Error if neither exists
#
# REBUILD STRATEGIES (--rebuild flag):
#   - all: Rebuild all services (default)
#   - backend-only: Only rebuild backend, keep database
#   - none: Start without rebuilding
#
# USAGE EXAMPLES:
#   dart_cloud_deploy deploy-local -c deploy.yaml
#   dart_cloud_deploy deploy-local -c deploy.yaml --env-file .env.local
#   dart_cloud_deploy deploy-local -c deploy.yaml --rebuild backend-only
#   dart_cloud_deploy deploy-local -c deploy.yaml --service backend-cloud
#   dart_cloud_deploy deploy-local -c deploy.yaml --force
# =============================================================================

name: dart_cloud_production
environment: production # Change to: local, staging, or production
project_path: /path/to/your/project

# -----------------------------------------------------------------------------
# ENVIRONMENT FILE (RECOMMENDED)
# -----------------------------------------------------------------------------
# Path to .env file containing environment variables.
# Can be absolute or relative to project_path.
# This is the RECOMMENDED way to provide secrets for local deployment.
env_file_path: .env.production

# -----------------------------------------------------------------------------
# HOST CONFIGURATION (for remote deployment)
# -----------------------------------------------------------------------------
host:
  host: your-server.example.com
  port: 22
  user: deploy
  ssh_key_path: ~/.ssh/id_rsa

# -----------------------------------------------------------------------------
# CONTAINER REGISTRY (optional, for image distribution)
# -----------------------------------------------------------------------------
registry:
  url: gitea.example.com
  username: your-username
  # Base64-encoded token: echo -n "your-token" | base64
  token_base64: eW91ci1naXRlYS10b2tlbi1oZXJl

# -----------------------------------------------------------------------------
# CONTAINER CONFIGURATION
# -----------------------------------------------------------------------------
# You can define environment-specific container configurations:
#   - production_container: Used when environment=production
#   - staging_container: Used when environment=staging
#   - local_container: Used when environment=local
#   - container: Base config (fallback for all environments)
#
# The system will automatically select the appropriate config based on
# the environment field above.
# -----------------------------------------------------------------------------

# Base container config (fallback)
container:
  runtime: docker # docker or podman
  compose_file: docker-compose.yml
  project_name: dart_cloud
  network_name: dart_cloud_network
  rebuild_strategy: all # all, backend-only, none
  services:
    backend: backend-cloud
    postgres: postgres

# Production-specific container config (overrides base when environment=production)
production_container:
  runtime: docker
  compose_file: docker-compose.prod.yml
  project_name: dart_cloud_prod
  network_name: dart_cloud_prod_net
  rebuild_strategy: none # Use pre-built images from registry
  services:
    backend: backend-cloud
    postgres: postgres
    redis: redis
    nginx: nginx

# -----------------------------------------------------------------------------
# ANSIBLE CONFIGURATION (for remote deployment)
# -----------------------------------------------------------------------------
ansible:
  backend_playbook: playbooks/backend.yml
  database_playbook: playbooks/database.yml
  backup_playbook: playbooks/backup.yml
  extra_vars:
    app_dir: /opt/dart_cloud
    data_dir: /var/lib/dart_cloud/postgres
    backup_dir: /var/backups/dart_cloud
    postgres_user: dart_cloud
    postgres_db: dart_cloud
    backup_retention_days: 7

# -----------------------------------------------------------------------------
# OPENBAO CONFIGURATION (FALLBACK for secrets)
# -----------------------------------------------------------------------------
# OpenBao is used as a FALLBACK when no env_file_path is provided.
# If both env_file_path and openbao are missing, deployment will fail.
openbao:
  address: https://openbao.example.com:8200
  namespace: dart_cloud
  # Environment-specific configurations
  local:
    token_manager: auth/approle
    policy: dart_cloud_local
    secret_path: secret/data/dart_cloud/local
    role_id: your-local-role-id
    role_name: dart_cloud_local
  staging:
    token_manager: auth/approle
    policy: dart_cloud_staging
    secret_path: secret/data/dart_cloud/staging
    role_id: your-staging-role-id
    role_name: dart_cloud_staging
  production:
    token_manager: auth/approle
    policy: dart_cloud_production
    secret_path: secret/data/dart_cloud/production
    role_id: your-production-role-id
    role_name: dart_cloud_production
